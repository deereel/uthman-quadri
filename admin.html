<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .success { color: green; margin-top: 10px; }
        .error { color: red; margin-top: 10px; }
        .warning { color: orange; margin-top: 10px; }
        #parsedData { background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 15px 0; }
        #verifySection { background: #e8f4fd; padding: 15px; border-radius: 4px; margin: 15px 0; display: none; }
        small { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Portfolio Admin Panel</h1>
    
    <form id="projectForm">
        <div class="form-group">
            <label for="title">Project Title</label>
            <input type="text" id="title" required>
        </div>
        
        <div class="form-group">
            <label for="status">Status</label>
            <select id="status" required>
                <option value="">Select Status</option>
                <option value="Completed">Completed</option>
                <option value="In Progress">In Progress</option>
                <option value="Planned">Planned</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="summaryFile">Summary.txt File (for parsing only)</label>
            <input type="file" id="summaryFile" accept=".txt" required>
        </div>
        
        <div id="parsedData" style="display: none;">
            <h3>Parsed from Summary.txt:</h3>
            <div><strong>Description:</strong> <span id="parsedDescription"></span></div>
            <div><strong>Tools:</strong> <span id="parsedTools"></span></div>
            <div><strong>Author:</strong> <span id="parsedAuthor"></span></div>
            <div><strong>Categories:</strong> <span id="parsedCategories"></span></div>
        </div>
        
        <button type="submit">Create Project Record</button>
    </form>
    
    <div id="verifySection">
        <h3>Step 2: Upload Files to Airtable</h3>
        <p>1. Go to your Airtable base and find the created record</p>
        <p>2. Upload Summary.txt to the "Summary" field</p>
        <p>3. Upload Documentation PDF to the "Documentation" field</p>
        <p>4. Upload Images to the "Images" field (name first image as "0.jpg")</p>
        <button type="button" id="verifyBtn">Verify Files Uploaded</button>
    </div>
    
    <div id="message"></div>

    <script>
        const AIRTABLE_API_KEY = 'patU6popFbTUeRffY.5be688e9a4cdff9af1ff208cecafa3479f485d24e6971fa2b1dd6a970b31f192';
        const BASE_ID = 'appq3cC3epOtK5jc3';
        const TABLE_NAME = 'Projects';

        let parsedSummaryData = {};
        let currentRecordId = null;

        function parseSummaryTxt(content) {
            const normalizedContent = content.replace(/\r\n/g, '\n');
            const sections = normalizedContent.split('\n\n\n').filter(s => s.trim());
            const data = {};

            sections.forEach(section => {
                const lines = section.split('\n');
                const header = lines[0].trim();
                const body = lines.slice(1).join('\n').trim();

                if (header === 'Short Summary') {
                    data.description = body;
                } else if (header === 'Tools') {
                    data.tools = body;
                } else if (header === 'Author') {
                    data.author = body;
                }
            });

            return data;
        }

        function getCategories(tools) {
            const categories = [];
            if (!tools) return 'make';
            
            if (tools.includes('Make.com')) categories.push('make');
            if (tools.includes('Zapier')) categories.push('zapier');
            if (tools.includes('Airtable')) categories.push('airtable');
            if (tools.includes('n8n')) categories.push('n8n');
            
            return categories.length > 0 ? categories.join(',') : 'make';
        }

        document.getElementById('summaryFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    parsedSummaryData = parseSummaryTxt(e.target.result);
                    const categories = getCategories(parsedSummaryData.tools);
                    
                    document.getElementById('parsedDescription').textContent = parsedSummaryData.description || 'Not found';
                    document.getElementById('parsedTools').textContent = parsedSummaryData.tools || 'Not found';
                    document.getElementById('parsedAuthor').textContent = parsedSummaryData.author || 'Not found';
                    document.getElementById('parsedCategories').textContent = categories;
                    
                    document.getElementById('parsedData').style.display = 'block';
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const projectData = {
                    fields: {
                        Title: document.getElementById('title').value,
                        Status: 'In Progress', // Start as In Progress until verified
                        Description: parsedSummaryData.description || '',
                        Tools: parsedSummaryData.tools || '',
                        Author: parsedSummaryData.author || '',
                        Categories: getCategories(parsedSummaryData.tools)
                    }
                };

                const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(projectData)
                });

                if (response.ok) {
                    const result = await response.json();
                    currentRecordId = result.id;
                    
                    document.getElementById('message').innerHTML = '<div class="warning">Project record created! Now upload files to Airtable and click Verify.</div>';
                    document.getElementById('verifySection').style.display = 'block';
                    document.querySelector('button[type="submit"]').disabled = true;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Failed to add project');
                }
            } catch (error) {
                document.getElementById('message').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
            }
        });

        document.getElementById('verifyBtn').addEventListener('click', async () => {
            if (!currentRecordId) return;
            
            try {
                const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${currentRecordId}`, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                    }
                });

                if (response.ok) {
                    const record = await response.json();
                    const fields = record.fields;
                    
                    const hasSummary = fields.Summary && fields.Summary.length > 0;
                    const hasImages = fields.Images && fields.Images.length > 0;
                    
                    if (hasSummary && hasImages) {
                        // Update status to selected status
                        const updateResponse = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${currentRecordId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                fields: {
                                    Status: 'Completed'
                                }
                            })
                        });

                        if (updateResponse.ok) {
                            document.getElementById('message').innerHTML = '<div class="success">Project verified and finalized! It will appear on the website within 30 seconds.</div>';
                            document.getElementById('projectForm').reset();
                            document.getElementById('parsedData').style.display = 'none';
                            document.getElementById('verifySection').style.display = 'none';
                            document.querySelector('button[type="submit"]').disabled = false;
                            currentRecordId = null;
                            parsedSummaryData = {};
                        }
                    } else {
                        const missing = [];
                        if (!hasSummary) missing.push('Summary.txt');
                        if (!hasImages) missing.push('Images');
                        
                        document.getElementById('message').innerHTML = `<div class="error">Missing files: ${missing.join(', ')}. Please upload them to Airtable first.</div>`;
                    }
                }
            } catch (error) {
                document.getElementById('message').innerHTML = '<div class="error">Error verifying files: ' + error.message + '</div>';
            }
        });
    </script>
</body>
</html>